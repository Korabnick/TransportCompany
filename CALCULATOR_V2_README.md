# Калькулятор грузоперевозок v2.0

## Обзор

Новый оптимизированный калькулятор грузоперевозок с поддержкой:
- **Кэширования** для улучшения производительности
- **Rate limiting** для защиты от спама
- **Модульной архитектуры** для легкого расширения
- **API-first подхода** для интеграции с фронтендом

## Архитектура

### Backend компоненты

#### 1. Модели данных (`app/models.py`)
- `Vehicle` - модель транспортного средства
- `RouteRequest` - запрос на расчет маршрута
- `TimeRequest` - запрос на расчет времени
- `VehicleRequest` - запрос на фильтрацию транспорта
- `CalculationResult` - результат расчета
- `VehicleDatabase` - база данных транспорта

#### 2. Сервис калькулятора (`app/calculator_v2.py`)
- `CalculatorServiceV2` - основной сервис расчетов
- `DistanceService` - сервис для получения расстояний
- `RateLimiter` - система ограничения запросов
- Кэширование результатов с помощью Redis

#### 3. API маршруты (`app/routes_v2.py`)
- `/api/v2/calculator/step1` - расчет стоимости маршрута
- `/api/v2/calculator/step2` - фильтрация транспорта
- `/api/v2/calculator/step3` - итоговый расчет
- `/api/v2/calculator/complete` - полный расчет
- `/api/v2/vehicles` - получение списка транспорта
- `/api/v2/health` - проверка здоровья системы

### Frontend компоненты

#### JavaScript (`app/static/js/calculator_v2.js`)
- `CalculatorV2` - основной класс калькулятора
- Debounce для предотвращения спама запросов
- Обработка ошибок и уведомления
- Интеграция с новым API

## API Endpoints

### POST /api/v2/calculator/step1
Расчет стоимости маршрута и времени.

**Параметры:**
```json
{
  "from_address": "Санкт-Петербург, Невский пр. 1",
  "to_address": "Санкт-Петербург, Лиговский пр. 10",
  "duration_hours": 2,
  "pickup_time": "2025-01-15T14:00:00",
  "urgent_pickup": false
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "base_price": 500,
    "distance_cost": 375,
    "time_cost": 1600,
    "urgent_multiplier": 1.0,
    "distance_multiplier": 1.0,
    "total": 2475,
    "distance": 15.0
  }
}
```

### POST /api/v2/calculator/step2
Фильтрация доступного транспорта.

**Параметры:**
```json
{
  "passengers": 2,
  "loaders": 1,
  "height": 2.0,
  "length": 3.0,
  "body_type": "tent"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "vehicles": [
      {
        "id": 1,
        "name": "Газель Тент",
        "type": "gazel",
        "body_type": "tent",
        "price_per_hour": 800,
        "price_per_km": 25,
        "base_price": 500,
        "max_passengers": 2,
        "max_loaders": 1,
        "dimensions": {"height": 2.0, "length": 3.0, "width": 2.0},
        "capacity": 12.0,
        "description": "Идеально для перевозки мебели"
      }
    ],
    "count": 1
  }
}
```

### POST /api/v2/calculator/step3
Расчет итоговой стоимости.

**Параметры:**
```json
{
  "step1_result": {
    "total": 2475,
    "distance": 15.0
  },
  "selected_vehicle_id": 1,
  "loaders": 1,
  "duration_hours": 2
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "breakdown": {
      "route_cost": 2475,
      "vehicle_cost": 2100,
      "loaders_cost": 1000,
      "total": 5575
    },
    "selected_vehicle": {
      "id": 1,
      "name": "Газель Тент"
    }
  }
}
```

## Оптимизации

### 1. Кэширование
- Результаты расчетов кэшируются в Redis на 5 минут
- Расстояния между адресами кэшируются на 1 час
- Фильтрация транспорта кэшируется на 5 минут

### 2. Rate Limiting
- Step1: 20 запросов в минуту
- Step2: 30 запросов в минуту
- Step3: 15 запросов в минуту
- Complete: 10 запросов в минуту
- Vehicles: 50 запросов в минуту

### 3. Debounce на фронтенде
- Задержка 500ms между запросами при изменении адресов
- Предотвращение спама при быстром вводе

### 4. Мониторинг производительности
- Метрики времени выполнения каждого этапа
- Логирование запросов и ошибок
- Health check для проверки состояния системы

## База транспорта

В системе доступны следующие типы транспорта:

1. **Газель Тент** - для мебели и бытовой техники
2. **Газель Фургон** - для ценных грузов
3. **Грузовик 5 тонн** - для крупных перевозок
4. **Микроавтобус** - для пассажиров с грузом
5. **Спецтранспорт** - для особо крупных грузов

Каждый транспорт имеет:
- Фиксированную базовую стоимость
- Стоимость за час работы
- Стоимость за километр
- Максимальное количество пассажиров и грузчиков
- Габариты и объем кузова

## Установка и запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте Redis (для кэширования):
```bash
docker run -d -p 6379:6379 redis:alpine
```

3. Запустите приложение:
```bash
python app/__init__.py
```

4. Проверьте API:
```bash
curl http://localhost:5000/api/v2/health
```

## Тестирование

### Тест расчета маршрута:
```bash
curl -X POST http://localhost:5000/api/v2/calculator/step1 \
  -H "Content-Type: application/json" \
  -d '{
    "from_address": "Санкт-Петербург, Невский пр. 1",
    "to_address": "Санкт-Петербург, Лиговский пр. 10",
    "duration_hours": 2,
    "pickup_time": "2025-01-15T14:00:00",
    "urgent_pickup": false
  }'
```

### Тест фильтрации транспорта:
```bash
curl -X POST http://localhost:5000/api/v2/calculator/step2 \
  -H "Content-Type: application/json" \
  -d '{
    "passengers": 2,
    "loaders": 1,
    "body_type": "tent"
  }'
```

## Мониторинг

### Метрики Prometheus
- `calculator_step1_duration_seconds` - время выполнения шага 1
- `calculator_step2_duration_seconds` - время выполнения шага 2
- `calculator_step3_duration_seconds` - время выполнения шага 3
- `calculator_complete_duration_seconds` - время полного расчета

### Логи
- Все запросы логируются с параметрами
- Ошибки логируются с детальной информацией
- Rate limit превышения логируются отдельно

## Расширение функционала

### Добавление нового транспорта:
1. Добавьте запись в `VehicleDatabase._initialize_vehicles()`
2. Обновите фильтры в `filter_vehicles()` при необходимости

### Интеграция с реальным API карт:
1. Замените заглушку в `DistanceService.get_distance()`
2. Добавьте API ключи в конфигурацию
3. Обновите кэширование для новых запросов

### Добавление новых тарифов:
1. Обновите константы в `DistanceService.calculate_route_price()`
2. Добавьте новые коэффициенты и скидки
3. Обновите логику расчета в соответствующих методах

## Безопасность

- Rate limiting защищает от DDoS атак
- Валидация входных данных предотвращает инъекции
- Логирование помогает отслеживать подозрительную активность
- Кэширование снижает нагрузку на сервер

## Производительность

- Кэширование снижает время ответа на 70-80%
- Rate limiting предотвращает перегрузку сервера
- Debounce на фронтенде снижает количество запросов
- Оптимизированные запросы к базе данных

## Заключение

Новый калькулятор v2.0 обеспечивает:
- Высокую производительность при большом потоке пользователей
- Защиту от спама и злоупотреблений
- Модульную архитектуру для легкого расширения
- Современный API для интеграции с различными клиентами
- Подробное логирование и мониторинг 