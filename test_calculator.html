<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Test</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
</head>
<body class="p-8">
    <h1 class="text-2xl font-bold mb-4">Calculator Test</h1>
    
    <div class="space-y-4">
        <div>
            <label class="block text-sm text-gray-600 mb-1">Откуда</label>
            <input id="fromAddress" type="text" placeholder="Откуда" class="w-full px-4 py-2 border border-gray-200 rounded">
        </div>
        
        <div>
            <label class="block text-sm text-gray-600 mb-1">Куда</label>
            <input id="toAddress" type="text" placeholder="Куда" class="w-full px-4 py-2 border border-gray-200 rounded">
        </div>
        
        <div>
            <label class="block text-sm text-gray-600 mb-1">Срочная подача</label>
            <input id="urgentPickup" type="checkbox" class="mr-2">
            <span>Подача в течение 20 минут (+30% к стоимости)</span>
        </div>
        
        <div>
            <label class="block text-sm text-gray-600 mb-1">Длительность</label>
            <select id="durationSelect" class="w-full px-4 py-2 border border-gray-200 rounded">
                <option value="1">1 час</option>
                <option value="2">2 часа</option>
                <option value="3">3 часа</option>
            </select>
        </div>
        
        <div id="step1Results" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg border">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Расстояние:</span>
                <span id="step1Distance" class="font-semibold">0 км</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Стоимость:</span>
                <span id="step1Price" class="font-bold text-lg text-orange-600">0 ₽</span>
            </div>
        </div>
        
        <div id="step3" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg border">
            <h3 class="font-bold">Шаг 3: Результаты</h3>
            <div class="flex justify-between text-sm items-center">
                <span class="text-gray-600 font-medium">Стоимость маршрута</span>
                <span id="routeCost" class="text-gray-800 font-semibold">0 ₽</span>
            </div>
        </div>
    </div>
    
    <script>
        // Simplified calculator logic for testing
        class TestCalculator {
            constructor() {
                this.calculationData = {
                    step1: {},
                    step2: {},
                    step3: {}
                };
                this.bindEvents();
            }
            
            bindEvents() {
                const fromInput = document.getElementById('fromAddress');
                const toInput = document.getElementById('toAddress');
                const urgentCheckbox = document.getElementById('urgentPickup');
                const durationSelect = document.getElementById('durationSelect');
                
                [fromInput, toInput].forEach(input => {
                    input.addEventListener('input', () => {
                        this.calculateStep1();
                    });
                });
                
                urgentCheckbox.addEventListener('change', () => {
                    this.recalculateStep1Cost();
                });
                
                durationSelect.addEventListener('change', () => {
                    this.recalculateStep1Cost();
                });
            }
            
            calculateStep1() {
                const fromAddress = document.getElementById('fromAddress').value;
                const toAddress = document.getElementById('toAddress').value;
                const durationHours = parseInt(document.getElementById('durationSelect').value) || 1;
                const urgentPickup = document.getElementById('urgentPickup').checked;
                
                console.log('calculateStep1 called with:', { fromAddress, toAddress, durationHours, urgentPickup });
                
                if (!fromAddress || !toAddress) {
                    console.log('Missing addresses');
                    return;
                }
                
                // Estimate distance
                const distance = this.estimateDistance(fromAddress, toAddress);
                const totalCost = this.calculateTotalCost(distance, durationHours, urgentPickup);
                
                const routeData = {
                    distance: distance,
                    duration: durationHours * 60,
                    from_address: fromAddress,
                    to_address: toAddress,
                    duration_hours: durationHours,
                    urgent_pickup: urgentPickup,
                    total: totalCost
                };
                
                this.calculationData.step1 = routeData;
                this.updateStep1Display(routeData);
                this.updateRouteCostDisplay();
                
                console.log('Step1 calculation completed:', routeData);
            }
            
            estimateDistance(fromAddress, toAddress) {
                const fromLower = fromAddress.toLowerCase();
                const toLower = toAddress.toLowerCase();
                
                if ((fromLower.includes('спб') || fromLower.includes('санкт-петербург')) &&
                    (toLower.includes('спб') || toLower.includes('санкт-петербург'))) {
                    return 15.0;
                }
                
                if (fromLower.includes('область') || toLower.includes('область')) {
                    return 45.0;
                }
                
                return 30.0;
            }
            
            calculateTotalCost(distance, durationHours, urgentPickup) {
                const baseCostPerKm = 10;
                const distanceCost = distance * baseCostPerKm;
                
                let urgentMultiplier = 1;
                if (urgentPickup) {
                    urgentMultiplier = 1.3;
                }
                
                const totalCost = Math.round(distanceCost * urgentMultiplier);
                
                console.log('Total cost calculation:', {
                    distance,
                    distanceCost,
                    urgentPickup,
                    urgentMultiplier,
                    totalCost
                });
                
                return totalCost;
            }
            
            recalculateStep1Cost() {
                if (!this.calculationData.step1 || !this.calculationData.step1.distance) {
                    console.log('No step1 data available for recalculation');
                    return;
                }
                
                const distance = this.calculationData.step1.distance;
                const durationHours = parseInt(document.getElementById('durationSelect').value) || 1;
                const urgentPickup = document.getElementById('urgentPickup').checked;
                
                console.log('Recalculating step1 cost with:', { distance, durationHours, urgentPickup });
                
                const newTotal = this.calculateTotalCost(distance, durationHours, urgentPickup);
                
                this.calculationData.step1.total = newTotal;
                this.calculationData.step1.duration_hours = durationHours;
                this.calculationData.step1.urgent_pickup = urgentPickup;
                
                console.log('Updated step1 total:', newTotal);
                
                this.updateStep1Display(this.calculationData.step1);
                this.updateRouteCostDisplay();
            }
            
            updateStep1Display(data) {
                const priceElement = document.getElementById('step1Price');
                const distanceElement = document.getElementById('step1Distance');
                const resultsBlock = document.getElementById('step1Results');
                const step3 = document.getElementById('step3');
                
                if (priceElement) {
                    priceElement.textContent = `${Math.round(data.total)} ₽`;
                }
                
                if (distanceElement) {
                    distanceElement.textContent = `${data.distance} км`;
                }
                
                if (resultsBlock) {
                    resultsBlock.classList.remove('hidden');
                }
                
                if (step3 && step3.classList.contains('hidden')) {
                    step3.classList.remove('hidden');
                }
                
                console.log('Step1 display updated:', data);
            }
            
            updateRouteCostDisplay() {
                if (this.calculationData.step1 && this.calculationData.step1.total) {
                    const routeCostElement = document.getElementById('routeCost');
                    if (routeCostElement) {
                        routeCostElement.textContent = `${Math.round(this.calculationData.step1.total)} ₽`;
                        console.log('Route cost updated:', this.calculationData.step1.total);
                    } else {
                        console.error('Route cost element not found');
                    }
                } else {
                    console.log('No step1 data available for route cost display');
                }
            }
        }
        
        // Initialize calculator when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.testCalculator = new TestCalculator();
        });
    </script>
</body>
</html> 