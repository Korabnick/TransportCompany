# –ó–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∑–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–æ–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞:
- **–í–Ω—É—Ç—Ä–∏ –≥–æ—Ä–æ–¥–∞** - –±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã
- **–ó–∞ –ö–ê–î (–ö–æ–ª—å—Ü–µ–≤–æ–π –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–æ–π)** - –ø–æ–≤—ã—à–µ–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã + —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–µ–∑–¥–∞ –ø–æ –ö–ê–î

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **ZoneDistanceService** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π —Å —É—á—ë—Ç–æ–º –∑–æ–Ω
2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–æ–Ω** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –∏ —Ç–∞—Ä–∏—Ñ–æ–≤
3. **API endpoints** - –Ω–æ–≤—ã–µ endpoints –¥–ª—è –∑–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
4. **Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω

#### –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- –ö–ê–î, –∫–æ–ª—å—Ü–µ–≤–∞—è, –æ–±—ä–µ–∑–¥–Ω–∞—è, –æ–±–ª–∞—Å—Ç—å, –æ–±–ª–∞—Å—Ç–Ω–æ–π ‚Üí –∑–æ–Ω–∞ "outside"

#### –ü–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –≥–æ—Ä–æ–¥–∞ (59.9311, 30.3609)
- –†–∞–¥–∏—É—Å –≥–æ—Ä–æ–¥–∞: 25 –∫–º (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –í–Ω—É—Ç—Ä–∏ —Ä–∞–¥–∏—É—Å–∞ ‚Üí –∑–æ–Ω–∞ "city"
- –ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ ‚Üí –∑–æ–Ω–∞ "outside"

### –¢–∏–ø—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤

1. **city_only** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ –≥–æ—Ä–æ–¥—É
2. **outside_only** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞ –ö–ê–î
3. **mixed** - —Å–º–µ—à–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ calculator_config.json

```json
{
  "pricing": {
    "base_cost_per_km": 10.0,
    "city_cost_per_km": 8.0,
    "outside_cost_per_km": 15.0,
    "kad_toll_cost": 100.0,
    "zone_detection": {
      "city_center": {
        "lat": 59.9311,
        "lng": 30.3609
      },
      "city_radius_km": 25.0,
      "kad_keywords": ["–ö–ê–î", "–∫–æ–ª—å—Ü–µ–≤–∞—è", "–æ–±—ä–µ–∑–¥–Ω–∞—è", "–æ–±–ª–∞—Å—Ç—å", "–æ–±–ª–∞—Å—Ç–Ω–æ–π"],
      "kad_distance_threshold_km": 30.0
    }
  }
}
```

## API Endpoints

### –ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∑–æ–Ω–∞–º–∏

```http
POST /api/v2/calculator/zone-analysis
Content-Type: application/json

{
  "from_address": "–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 1",
  "to_address": "–ü—É—à–∫–∏–Ω, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "total_distance": 25.3,
    "city_distance": 15.2,
    "outside_distance": 10.1,
    "from_zone": "city",
    "to_zone": "outside",
    "route_type": "mixed",
    "kad_toll_applied": true
  }
}
```

### –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å —É—á—ë—Ç–æ–º –∑–æ–Ω

```http
POST /api/v2/calculator/zone-pricing
Content-Type: application/json

{
  "from_address": "–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 1",
  "to_address": "–ü—É—à–∫–∏–Ω, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
  "duration_hours": 3,
  "urgent_pickup": false
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "route_analysis": { ... },
    "pricing": {
      "city_cost": 121.6,
      "outside_cost": 151.5,
      "duration_cost": 300,
      "kad_cost": 100,
      "base_total_cost": 673.1,
      "urgent_multiplier": 1.0,
      "total": 673
    }
  }
}
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Backend

```python
from app.calculator import ZoneDistanceService

# –ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞
analysis = ZoneDistanceService.get_distance_with_zones(
    "–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 1",
    "–ü—É—à–∫–∏–Ω, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
)

# –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
pricing = ZoneDistanceService.calculate_route_price_with_zones(
    analysis,
    duration_hours=3,
    urgent_pickup=False
)
```

### Frontend

```javascript
// –ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞
const response = await fetch('/api/v2/calculator/zone-analysis', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        from_address: '–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 1',
        to_address: '–ü—É—à–∫–∏–Ω, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
    })
});

const data = await response.json();
console.log(data.data.route_type); // "mixed"
```

## –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–æ–Ω–∞—Ö –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ:

- üöó **–ú–∞—Ä—à—Ä—É—Ç –ø–æ –≥–æ—Ä–æ–¥—É** - –∑–µ–ª—ë–Ω—ã–π –±–ª–æ–∫
- üõ£Ô∏è **–ú–∞—Ä—à—Ä—É—Ç –∑–∞ –ö–ê–î** - –æ—Ä–∞–Ω–∂–µ–≤—ã–π –±–ª–æ–∫  
- üîÑ **–°–º–µ—à–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç** - —Å–∏–Ω–∏–π –±–ª–æ–∫

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–µ–∑–¥–∞ –ø–æ –ö–ê–î, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:

```bash
python test_zone_calculation.py
```

–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω –ø–æ –∞–¥—Ä–µ—Å–∞–º
- –ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 —á–∞—Å
- –ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- Batch-–∑–∞–ø—Ä–æ—Å—ã –∫ API –∫–∞—Ä—Ç
- Fallback —Ä–∞—Å—á—ë—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–æ–Ω

1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `calculator_config.json`
2. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–æ–Ω—ã –≤ `ZoneDistanceService._determine_zone()`
3. –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ `calculate_route_price_with_zones()`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API –∫–∞—Ä—Ç

–ó–∞–º–µ–Ω–∏—Ç—å –∑–∞–≥–ª—É—à–∫–∏ –≤ `_get_coordinates()` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã:

```python
import requests

def _get_coordinates(address: str):
    url = "https://nominatim.openstreetmap.org/search"
    params = {
        'q': address,
        'format': 'json',
        'limit': 1
    }
    response = requests.get(url, params=params)
    data = response.json()
    
    if data:
        return {
            'lat': float(data[0]['lat']),
            'lng': float(data[0]['lon'])
        }
    return None
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º API:
- –í—Å–µ —Å—Ç–∞—Ä—ã–µ endpoints –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ—Ç–≤–µ—Ç–∞–º
- Fallback –∫ —Å—Ç–∞—Ä–æ–º—É —Ä–∞—Å—á—ë—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç:
- –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
- –û—à–∏–±–∫–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API –∑–∞–ø—Ä–æ—Å–æ–≤

–ú–µ—Ç—Ä–∏–∫–∏ Prometheus:
- `calculator_zone_analysis_duration_seconds`
- `calculator_zone_pricing_duration_seconds`
